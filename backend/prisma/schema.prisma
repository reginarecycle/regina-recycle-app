// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

/// ENUMS
enum Role {
  CUSTOMER
  COLLECTOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum NotificationChannel {
  EMAIL
  IN_APP
}

enum NotificationType {
  EMAIL_PICKUP_REMINDER
  IN_APP_PICKUP_REMINDER
  ACCOUNT_ACTIVITY
  MARKETING
  ALERT
}

enum PickupStatus {
  PENDING
  IN_PROGRESS
  ACCEPTED
  COMPLETED
  CANCELLED
}

enum TxType {
  CREDIT
  DEBIT
}

enum TxStatus {
  PENDING
  FAILED
  COMPLETED
}

enum PricingStatus {
  ACTIVE
  INACTIVE
}

/// MODELS
model User {
  userId            String    @id @default(uuid())
  role              Role      @default(CUSTOMER)
  name              String
  email             String    @unique
  phoneNumber       String?
  passwordHash      String
  emailVerified     Boolean   @default(false)
  status            UserStatus @default(ACTIVE)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Notification preferences
  emailPickupReminder    Boolean @default(true)
  emailAccountActivity   Boolean @default(true)
  emailMarketing         Boolean @default(false)
  inAppPickupReminder    Boolean @default(true)
  inAppAlerts            Boolean @default(true)

  // Role-specific optional relations (no columns created on users table)
  customerDOB       CustomerDOB?       // one-to-one (only for CUSTOMER)
  collectorProfile  CollectorProfile?  // one-to-one (only for COLLECTOR)

  // common relations
  addresses         Address[]
  paymentMethods    PaymentMethod[]
  pickupsRequested  Pickup[] @relation("requester")
  pickupsCollected  Pickup[] @relation("collector")
  notifications     Notification[]
  wallet            Wallet?
  walletTransactions WalletTransaction[]
  collectorPricings CollectorPricing[]
  topUpRequests     TopUpRequest[]
  withdrawRequests  WithdrawRequest[]

  @@map("users")
}

model CustomerDOB {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  dob       DateTime
  createdAt DateTime @default(now())

  @@map("customer_dobs")
}

model CollectorProfile {
  collectorProfileId String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  licenseId          String   @unique
  serviceFee         Decimal  @db.Decimal(10,2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("collector_profiles")
}

model Address {
  addressId  String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String
  latitude   Float?
  longitude  Float?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  pickups Pickup[]  // pickups that reference this address

  @@map("addresses")
  @@index([userId])
}

model Material {
  materialId String   @id @default(uuid())
  name       String
  type       String
  photoUrl   String?
  co2Saved   Float?
  waterSaved Float?
  createdAt  DateTime @default(now())

  collectorPricings CollectorPricing[]
  pickupItems       PickupItem[]

  @@map("materials")
}

model CollectorPricing {
  collectorPricingId String       @id @default(uuid())
  collectorUserId    String
  collector          User         @relation(fields: [collectorUserId], references: [userId], onDelete: Cascade)
  materialId         String
  material           Material     @relation(fields: [materialId], references: [materialId], onDelete: Cascade)
  price              Decimal      @db.Decimal(14,2)
  status             PricingStatus @default(ACTIVE)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([collectorUserId, materialId])
  @@map("collector_pricing")
  @@index([collectorUserId])
  @@index([materialId])
}

model Pickup {
  pickupId        String     @id @default(uuid())
  requesterUserId String
  requester       User       @relation("requester", fields: [requesterUserId], references: [userId], onDelete: Cascade)
  collectorUserId String?
  collector       User?      @relation("collector", fields: [collectorUserId], references: [userId], onDelete: SetNull)
  scheduledAt     DateTime
  addressId       String?
  address         Address?   @relation(fields: [addressId], references: [addressId], onDelete: SetNull)
  status          PickupStatus @default(PENDING)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // recorded by collector when processing completion
  actualEarning   Decimal?   @db.Decimal(14,2)

  items     PickupItem[]
  snapshots PickupSnapshot[]

  @@map("pickups")
  @@index([requesterUserId])
  @@index([collectorUserId])
  @@index([status])
}

model PickupItem {
  pickupId   String
  pickup     Pickup   @relation(fields: [pickupId], references: [pickupId], onDelete: Cascade)
  materialId String
  material   Material @relation(fields: [materialId], references: [materialId], onDelete: Cascade)
  quantity   Int

  @@id([pickupId, materialId])
  @@map("pickup_items")
  @@index([materialId])
}

model PickupSnapshot {
  snapshotId       String   @id @default(uuid())
  pickupId         String
  pickup           Pickup   @relation(fields: [pickupId], references: [pickupId], onDelete: Cascade)
  capturedAt       DateTime @default(now())
  estimatedEarning Decimal? @db.Decimal(14,2)
  totalItems       Int?

  @@map("pickup_snapshots")
  @@index([pickupId])
}

model Wallet {
  walletId  String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  balance   Decimal  @db.Decimal(14,2) @default("0.00")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  transactionId String   @id @default(uuid())
  walletId      String
  wallet        Wallet   @relation(fields: [walletId], references: [walletId], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  createdAt     DateTime @default(now())
  type          TxType
  status        TxStatus @default(PENDING)
  description   String?
  amount        Decimal  @db.Decimal(14,2)
  referenceType String?
  referenceId   String?

  @@map("wallet_transactions")
  @@index([userId])
  @@index([walletId])
}

model TopUpRequest {
  topUpId         String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [paymentMethodId], onDelete: SetNull)
  amount          Decimal  @db.Decimal(14,2)
  status          TxStatus @default(PENDING)
  requestedAt     DateTime @default(now())
  processedAt     DateTime?

  @@map("topup_requests")
  @@index([userId])
}

model PaymentMethod {
  paymentMethodId String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  cardLast4       String?
  cardBrand       String?
  expMonth        Int?
  expYear         Int?
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())

  topUpRequests TopUpRequest[]

  @@map("payment_methods")
  @@index([userId])
}

model WithdrawRequest {
  withdrawId         String   @id @default(uuid())
  userId             String
  user               User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  interacEmail       String
  securityQuestion   String?
  securityAnswerHash String?
  amount             Decimal  @db.Decimal(14,2)
  status             TxStatus @default(PENDING)
  requestedAt        DateTime @default(now())
  processedAt        DateTime?

  @@map("withdraw_requests")
  @@index([userId])
}

model Notification {
  notificationId String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  channel        NotificationChannel
  type           NotificationType
  title          String?
  body           String?
  isRead         Boolean   @default(false)
  deliveredAt    DateTime?
  createdAt      DateTime  @default(now())

  @@index([userId, isRead])
  @@map("notifications")
}

model TipOfTheDay {
  tipId       String   @id @default(uuid())
  description String
  startDate   DateTime?
  endDate     DateTime?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("tips_of_the_day")
}